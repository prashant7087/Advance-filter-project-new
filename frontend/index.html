<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PupilBot</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.128.0/examples/js/controls/OrbitControls.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/control_utils/control_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"
        crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/face_mesh.js" crossorigin="anonymous"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #0a0c10;
            background-image: radial-gradient(circle at top right, rgba(37, 99, 235, 0.15), transparent 40%),
                radial-gradient(circle at bottom left, rgba(37, 99, 235, 0.1), transparent 50%);
            color: #e6edf3;
        }

        .fitter-card {
            background: rgba(13, 17, 23, 0.7);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(48, 54, 61, 0.5);
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.6);
        }

        .btn {
            background-image: linear-gradient(to right, #2563eb, #59a6f1);
            border: none;
            color: white;
            padding: 0.8rem 1.6rem;
            border-radius: 0.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(37, 99, 235, 0.3);
        }

        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(37, 99, 235, 0.4);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .input-field {
            background-color: #0d1117;
            border: 1px solid #30363d;
            color: #e6edf3;
            transition: all 0.2s ease-in-out;
        }

        .input-field:focus {
            border-color: #2563eb;
            box-shadow: 0 0 0 4px rgba(37, 99, 235, 0.2);
            outline: none;
        }

        .animated-entry {
            opacity: 0;
            transform: translateY(20px);
            animation: fadeIn 0.6s forwards;
        }

        @keyframes fadeIn {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .result-card {
            background-color: #161b22;
            border: 1px solid #30363d;
            opacity: 0;
            animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .result-card:hover {
            transform: scale(1.02);
            box-shadow: 0 0 20px rgba(37, 99, 235, 0.25);
        }

        @keyframes popIn {
            to {
                transform: scale(1);
                opacity: 1;
            }
        }

        .measurement-value {
            font-variant-numeric: tabular-nums;
        }

        #webcam-container {
            background-color: #000;
            position: relative;
        }

        #webcam-video {
            transform: scaleX(-1);
        }

        #capture-canvas,
        #best-frame-canvas {
            display: none;
        }

        .guide-text {
            position: absolute;
            top: 10%;
            color: white;
            background: rgba(0, 0, 0, 0.5);
            padding: 4px 10px;
            border-radius: 0.5rem;
        }

        .recording-indicator {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 20px;
            height: 20px;
            background-color: #ef4444;
            border-radius: 50%;
            animation: pulse-rec 1.5s infinite;
        }

        @keyframes pulse-rec {
            0% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }

            100% {
                transform: scale(0.9);
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }

        #head-animation {
            animation: turnHead 6s infinite ease-in-out;
        }

        @keyframes turnHead {

            0%,
            100% {
                transform: rotateY(0deg);
            }

            25% {
                transform: rotateY(30deg);
            }

            50% {
                transform: rotateY(0deg);
            }

            75% {
                transform: rotateY(-30deg);
            }
        }

        .login-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #2563eb, #59a6f1);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 25px rgba(37, 99, 235, 0.4);
        }

        .user-info-icon {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, #059669, #34d399);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1.5rem;
            box-shadow: 0 8px 25px rgba(5, 150, 105, 0.4);
        }
    </style>
</head>

<body class="flex items-center justify-center min-h-screen p-4">
    <div id="app-container" class="fitter-card w-full max-w-lg p-8 rounded-2xl transition-all duration-500">

        <!-- Header -->
        <div id="header" class="text-center mb-8 animated-entry">
            <div class="flex items-center justify-center mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none"
                    stroke="#59a6f1" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="mr-3">
                    <circle cx="6" cy="12" r="4"></circle>
                    <circle cx="18" cy="12" r="4"></circle>
                    <line x1="10" y1="12" x2="14" y2="12"></line>
                </svg>
                <h1 class="text-3xl font-bold text-white">PupilBot</h1>
            </div>
            <p class="text-gray-400">Hyper-precise optical measurements, powered by AI.</p>
        </div>

        <!-- Error Message -->
        <div id="error-message"
            class="hidden text-center p-3 mb-4 bg-red-900/70 border border-red-700 text-red-200 rounded-lg animated-entry">
        </div>

        <!-- Success Message -->
        <div id="success-message"
            class="hidden text-center p-3 mb-4 bg-green-900/70 border border-green-700 text-green-200 rounded-lg animated-entry">
        </div>

        <!-- ==================== LOGIN SECTION ==================== -->
        <div id="login-section" class="space-y-6 animated-entry">
            <div class="login-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none"
                    stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M15 3h4a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-4"></path>
                    <polyline points="10 17 15 12 10 7"></polyline>
                    <line x1="15" y1="12" x2="3" y2="12"></line>
                </svg>
            </div>
            <h2 class="text-xl font-semibold text-center text-white">Sign In to Continue</h2>
            <p class="text-center text-gray-400 text-sm">Enter your credentials to access the AI Fitter</p>

            <div class="space-y-4">
                <div>
                    <label for="login-email" class="block text-sm font-medium mb-2 text-gray-300">Email Address</label>
                    <input type="email" id="login-email" placeholder="admin@admin.com"
                        class="input-field w-full p-3 rounded-lg" autocomplete="email">
                </div>
                <div>
                    <label for="login-password" class="block text-sm font-medium mb-2 text-gray-300">Password</label>
                    <input type="password" id="login-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="input-field w-full p-3 rounded-lg" autocomplete="current-password">
                </div>
            </div>

            <button id="login-button" onclick="handleLogin()" class="btn w-full font-semibold py-3 rounded-lg">
                Sign In
            </button>
        </div>

        <!-- ==================== USER INFO SECTION ==================== -->
        <div id="user-info-section" class="hidden space-y-6 animated-entry">
            <div class="user-info-icon">
                <svg xmlns="http://www.w3.org/2000/svg" width="35" height="35" viewBox="0 0 24 24" fill="none"
                    stroke="white" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path>
                    <circle cx="12" cy="7" r="4"></circle>
                </svg>
            </div>
            <h2 class="text-xl font-semibold text-center text-white">Your Information</h2>
            <p class="text-center text-gray-400 text-sm">Please provide your details for the measurement record</p>

            <div class="space-y-4">
                <div>
                    <label for="user-name" class="block text-sm font-medium mb-2 text-gray-300">Full Name</label>
                    <input type="text" id="user-name" placeholder="Enter your full name"
                        class="input-field w-full p-3 rounded-lg" autocomplete="name">
                </div>
                <div>
                    <label for="user-phone" class="block text-sm font-medium mb-2 text-gray-300">Phone Number</label>
                    <input type="tel" id="user-phone" placeholder="Enter your phone number"
                        class="input-field w-full p-3 rounded-lg" autocomplete="tel">
                </div>
            </div>

            <button id="save-user-button" onclick="handleSaveUser()" class="btn w-full font-semibold py-3 rounded-lg">
                Continue to Measurement
            </button>
        </div>

        <!-- ==================== INSTRUCTIONS SECTION ==================== -->
        <div id="instructions-section" class="hidden space-y-6 animated-entry">
            <h2 class="text-xl font-semibold text-center text-white">Recording Instructions</h2>
            <div class="p-4 bg-black/20 rounded-lg border border-gray-700">
                <svg viewBox="-50 -60 100 120" class="w-full h-48">
                    <ellipse cx="0" cy="0" rx="40" ry="55" stroke-dasharray="4 4" stroke-width="1" stroke="#59a6f1"
                        fill="none"></ellipse>
                    <g id="head-animation">
                        <path d="M-25,50 C-45,-20 45,-20 25,50 Z" fill="#4a5568"></path>
                        <path d="M-15,-20 a15,18 0 0,0 30,0" fill="#2d3748"></path>
                    </g>
                </svg>
            </div>
            <ul class="text-gray-300 space-y-2 list-disc list-inside text-sm">
                <li>Hold your phone steady at eye level.</li>
                <li>Slowly turn your head from <strong>left to right</strong>.</li>
                <li>Ensure your face is well-lit and clearly visible.</li>
            </ul>
            <button onclick="showCaptureSection()" class="btn w-full font-semibold py-3 rounded-lg">
                I Understand, Proceed
            </button>
        </div>

        <!-- ==================== CAPTURE SECTION ==================== -->
        <div id="capture-section" class="hidden space-y-6">
            <div>
                <label class="block text-sm font-medium mb-2 text-gray-300">1. Prepare to Record</label>
                <div id="webcam-container" class="hidden rounded-lg">
                    <video id="webcam-video" class="w-full h-auto rounded-lg" playsinline></video>
                    <div id="recording-indicator" class="hidden recording-indicator"></div>
                    <div id="guide-text" class="guide-text">Finding your face...</div>
                </div>
                <canvas id="capture-canvas"></canvas>
                <canvas id="best-frame-canvas"></canvas>
                <button id="start-camera-button" onclick="startCamera()"
                    class="btn w-full font-semibold py-3 rounded-lg">
                    Start Camera
                </button>
            </div>
            <div>
                <label for="frameWidth" class="block text-sm font-medium mb-2 text-gray-300">2. Enter Total Frame Width
                    (mm)</label>
                <input type="number" id="frameWidth" placeholder="e.g., 142" class="input-field w-full p-2.5 rounded-lg"
                    value="142">
            </div>
            <button id="record-button" onclick="startRecording()" class="btn w-full font-semibold py-3 rounded-lg"
                disabled>
                Start 5 Second Recording
            </button>
        </div>

        <!-- ==================== PROCESSING SECTION ==================== -->
        <div id="processing-section" class="hidden">
            <div class="text-center h-full flex flex-col justify-center items-center space-y-4 py-8">
                <svg width="100" height="100" viewBox="-10 -20 120 140" class="w-24 h-24">
                    <defs>
                        <mask id="mask">
                            <rect x="-10" y="-20" width="120" height="140" fill="white"></rect>
                            <path d="M10,0 Q50, -15 90,0 T10,0" fill="black" />
                            <path d="M10,100 Q50,115 90,100 T10,100" fill="black" />
                            <circle cx="30" cy="40" r="10" fill="black" />
                            <circle cx="70" cy="40" r="10" fill="black" />
                        </mask>
                    </defs>
                    <path
                        d="M10,0 Q50, -15 90,0 T10,0 M10,100 Q50,115 90,100 T10,100 M20,40 A10,10 0 1,1 40,40 A10,10 0 1,1 20,40 M60,40 A10,10 0 1,1 80,40 A10,10 0 1,1 60,40"
                        stroke="#59a6f1" stroke-width="2" fill="none" mask="url(#mask)" />
                    <rect x="-10" y="0" width="120" height="2" fill="#59a6f1" style="transform: translateY(-10%);">
                        <animate attributeName="y" from="-20" to="120" dur="2s" repeatCount="indefinite" />
                    </rect>
                </svg>
                <p class="text-lg text-gray-300">Analyzing your biometrics...</p>
            </div>
        </div>

        <!-- ==================== RESULTS SECTION ==================== -->
        <div id="results-section" class="hidden">
            <div class="flex flex-col md:flex-row md:space-x-8">
                <div class="md:w-2/5 flex flex-col">
                    <!-- User Info Header -->
                    <div class="result-card rounded-lg p-4 mb-4 text-center">
                        <p class="text-sm text-gray-400 mb-1">Report for</p>
                        <h2 id="report-user-name" class="text-xl font-bold text-white">-</h2>
                        <p id="report-user-phone" class="text-gray-400 text-sm">-</p>
                    </div>

                    <h2 class="text-lg font-semibold text-center text-white mb-4">Measurements</h2>
                    <div class="grid grid-cols-2 gap-4 flex-grow">
                        <div class="result-card rounded-lg p-4 text-center">
                            <div class="flex items-center justify-center text-sm text-gray-400 mb-2">Pupillary Distance
                            </div>
                            <p id="pdResult" class="text-2xl font-bold text-white measurement-value">-</p>
                        </div>
                        <div class="result-card rounded-lg p-4 text-center">
                            <div class="flex items-center justify-center text-sm text-gray-400 mb-2">Fitting Height
                            </div>
                            <p id="fhResult" class="text-2xl font-bold text-white measurement-value">-</p>
                        </div>
                        <div class="result-card rounded-lg p-4 text-center">
                            <div class="flex items-center justify-center text-sm text-gray-400 mb-2">Pantoscopic Tilt
                            </div>
                            <p id="tiltResult" class="text-2xl font-bold text-white measurement-value">-</p>
                        </div>
                        <div class="result-card rounded-lg p-4 text-center">
                            <div class="flex items-center justify-center text-sm text-gray-400 mb-2">Vertex Distance
                            </div>
                            <p id="vertexResult" class="text-2xl font-bold text-white measurement-value">-</p>
                        </div>
                    </div>
                    <div class="flex gap-3 mt-8 justify-center">
                        <button onclick="handleRetake()" class="btn text-sm font-semibold px-6 py-2 rounded-lg">
                            ðŸ”„ Retake
                        </button>
                        <button onclick="handleExit()" class="btn text-sm font-semibold px-6 py-2 rounded-lg"
                            style="background: linear-gradient(to right, #dc2626, #f87171);">
                            âœ• Exit
                        </button>
                    </div>
                </div>
                <div class="md:w-3/5 mt-8 md:mt-0">
                    <div class="result-card rounded-lg p-4 text-center w-full h-full">
                        <p class="text-sm text-gray-400 mb-2">Interactive 3D Facial Model</p>
                        <div id="d3-container" class="rounded-lg bg-black/20 w-full h-96"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ==================== HISTORY SECTION ==================== -->
        <div id="history-section" class="hidden">
            <div class="flex items-center justify-between mb-6">
                <h2 class="text-xl font-semibold text-white">Measurement History</h2>
                <button onclick="showSection(userInfoSection)" class="btn text-sm font-semibold px-4 py-2 rounded-lg">+
                    New Test</button>
            </div>
            <div id="history-loading" class="text-center py-8 text-gray-400">Loading history...</div>
            <div id="history-list" class="space-y-4 hidden"></div>
            <div id="history-empty" class="hidden text-center py-8 text-gray-400">
                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48" viewBox="0 0 24 24" fill="none"
                    stroke="currentColor" stroke-width="1" class="mx-auto mb-4 opacity-50">
                    <path d="M3 3v5h5"></path>
                    <path d="M3 8l4-4a10 10 0 1 1-3.5 10"></path>
                </svg>
                <p>No measurements recorded yet.</p>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // CONFIGURATION
        // ========================================
        // IMPORTANT: Replace this with your actual Backend URL after deploying the backend
        const API_BASE_URL = 'https://advance-filter-project-new.vercel.app';

        // ========================================
        // STATE MANAGEMENT
        // ========================================
        let sessionToken = null;
        let currentUserId = null;
        let currentUserName = null;
        let currentUserPhone = null;

        // ========================================
        // DOM ELEMENTS
        // ========================================
        const appContainer = document.getElementById('app-container');
        const header = document.getElementById('header');
        const errorMessage = document.getElementById('error-message');
        const successMessage = document.getElementById('success-message');

        // Sections
        const loginSection = document.getElementById('login-section');
        const userInfoSection = document.getElementById('user-info-section');
        const instructionsSection = document.getElementById('instructions-section');
        const captureSection = document.getElementById('capture-section');
        const processingSection = document.getElementById('processing-section');
        const resultsSection = document.getElementById('results-section');
        const historySection = document.getElementById('history-section');

        // Report elements
        const reportUserName = document.getElementById('report-user-name');
        const reportUserPhone = document.getElementById('report-user-phone');

        // Login elements
        const loginEmail = document.getElementById('login-email');
        const loginPassword = document.getElementById('login-password');
        const loginButton = document.getElementById('login-button');

        // User info elements
        const userName = document.getElementById('user-name');
        const userPhone = document.getElementById('user-phone');

        // Capture elements
        const videoElement = document.getElementById('webcam-video');
        const startCameraButton = document.getElementById('start-camera-button');
        const webcamContainer = document.getElementById('webcam-container');
        const recordButton = document.getElementById('record-button');
        const guideText = document.getElementById('guide-text');
        const recordingIndicator = document.getElementById('recording-indicator');
        const bestFrameCanvas = document.getElementById('best-frame-canvas');
        const frameWidthInput = document.getElementById('frameWidth');

        // Result elements
        const pdResult = document.getElementById('pdResult');
        const fhResult = document.getElementById('fhResult');
        const tiltResult = document.getElementById('tiltResult');
        const vertexResult = document.getElementById('vertexResult');
        const d3Container = document.getElementById('d3-container');

        let bestScore = -1;
        let isRecording = false;
        let scene, camera, renderer, controls;

        // ========================================
        // MEDIAPIPE SETUP
        // ========================================
        const faceMesh = new FaceMesh({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/face_mesh/${file}` });
        faceMesh.setOptions({ maxNumFaces: 1, refineLandmarks: true, minDetectionConfidence: 0.5, minTrackingConfidence: 0.5 });
        faceMesh.onResults(onResults);
        const cameraMP = new Camera(videoElement, {
            onFrame: async () => await faceMesh.send({ image: videoElement }),
            width: 1280, height: 720
        });

        // ========================================
        // UTILITY FUNCTIONS
        // ========================================
        function showMessage(msg, isError = true) {
            if (isError) {
                errorMessage.textContent = msg;
                errorMessage.classList.remove('hidden');
                successMessage.classList.add('hidden');
            } else {
                successMessage.textContent = msg;
                successMessage.classList.remove('hidden');
                errorMessage.classList.add('hidden');
            }
        }

        function hideMessages() {
            errorMessage.classList.add('hidden');
            successMessage.classList.add('hidden');
        }

        function showSection(section) {
            const allSections = [loginSection, userInfoSection, instructionsSection, captureSection, processingSection, resultsSection, historySection];
            allSections.forEach(s => s.classList.add('hidden'));
            if (section) section.classList.remove('hidden');

            const isWide = section === resultsSection || section === historySection;
            if (isWide) {
                appContainer.classList.remove('max-w-lg');
                appContainer.classList.add('max-w-4xl');
            } else {
                appContainer.classList.remove('max-w-4xl', 'max-w-6xl');
                appContainer.classList.add('max-w-lg');
            }

            // Show header for login, user-info, instructions, and capture sections
            if ([loginSection, userInfoSection, instructionsSection, captureSection].includes(section)) {
                header.classList.remove('hidden');
            } else {
                header.classList.add('hidden');
            }
        }

        // ========================================
        // AUTHENTICATION
        // ========================================
        async function handleLogin() {
            const email = loginEmail.value.trim();
            const password = loginPassword.value;

            if (!email || !password) {
                showMessage('Please enter both email and password');
                return;
            }

            loginButton.disabled = true;
            loginButton.textContent = 'Signing in...';
            hideMessages();

            try {
                const response = await fetch(`${API_BASE_URL}/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();

                if (data.success) {
                    sessionToken = data.token;
                    showMessage('Login successful!', false);
                    setTimeout(() => {
                        hideMessages();
                        showHistorySection(); // Go to history page after login
                    }, 500);
                } else {
                    showMessage(data.error || 'Login failed. Please check your credentials.');
                }
            } catch (error) {
                showMessage(`Connection error: ${error.message}. Make sure the backend is running.`);
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Sign In';
            }
        }

        // Enter key handling for login
        loginEmail.addEventListener('keypress', (e) => { if (e.key === 'Enter') loginPassword.focus(); });
        loginPassword.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleLogin(); });

        // ========================================
        // USER INFO
        // ========================================
        async function handleSaveUser() {
            const name = userName.value.trim();
            const phone = userPhone.value.trim();

            if (!name || !phone) {
                showMessage('Please enter both name and phone number');
                return;
            }

            const saveButton = document.getElementById('save-user-button');
            saveButton.disabled = true;
            saveButton.textContent = 'Saving...';
            hideMessages();

            try {
                const response = await fetch(`${API_BASE_URL}/save-user`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, phone })
                });

                const data = await response.json();

                if (data.success) {
                    currentUserId = data.user_id;
                    currentUserName = name;
                    currentUserPhone = phone;
                    showMessage('Information saved!', false);
                    setTimeout(() => {
                        hideMessages();
                        showSection(instructionsSection);
                    }, 500);
                } else {
                    showMessage(data.error || 'Failed to save user information.');
                }
            } catch (error) {
                showMessage(`Connection error: ${error.message}`);
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Continue to Measurement';
            }
        }

        // Enter key handling for user info
        userName.addEventListener('keypress', (e) => { if (e.key === 'Enter') userPhone.focus(); });
        userPhone.addEventListener('keypress', (e) => { if (e.key === 'Enter') handleSaveUser(); });

        // ========================================
        // CAMERA & RECORDING
        // ========================================
        function showCaptureSection() {
            showSection(captureSection);
        }

        async function startCamera() {
            startCameraButton.disabled = true;
            startCameraButton.textContent = 'Starting...';
            try {
                await cameraMP.start();
                webcamContainer.classList.remove('hidden');
                startCameraButton.classList.add('hidden');
            } catch (err) {
                showMessage('Could not access webcam. Please check permissions.');
                startCameraButton.disabled = false;
                startCameraButton.textContent = 'Start Camera';
            }
        }

        function onResults(results) {
            if (!results.multiFaceLandmarks || results.multiFaceLandmarks.length === 0) {
                guideText.textContent = 'No face detected';
                recordButton.disabled = true;
                return;
            }
            if (!isRecording) {
                recordButton.disabled = false;
                guideText.textContent = 'Ready to Record';
            }

            if (isRecording) {
                const landmarks = results.multiFaceLandmarks[0];
                const score = calculateFrameScore(landmarks);
                if (score > bestScore) {
                    bestScore = score;
                    const ctx = bestFrameCanvas.getContext('2d');
                    bestFrameCanvas.width = videoElement.videoWidth;
                    bestFrameCanvas.height = videoElement.videoHeight;
                    ctx.save();
                    ctx.scale(-1, 1);
                    ctx.drawImage(videoElement, -bestFrameCanvas.width, 0, bestFrameCanvas.width, bestFrameCanvas.height);
                    ctx.restore();
                }
            }
        }

        function calculateFrameScore(landmarks) {
            const noseTip = landmarks[1];
            const leftEye = landmarks[33];
            const rightEye = landmarks[263];
            const yawScore = Math.abs((noseTip.x - leftEye.x) - (rightEye.x - noseTip.x));

            const leftEyeTop = landmarks[159];
            const leftEyeBottom = landmarks[145];
            const rightEyeTop = landmarks[386];
            const rightEyeBottom = landmarks[374];
            const leftEyeOpenness = Math.abs(leftEyeTop.y - leftEyeBottom.y);
            const rightEyeOpenness = Math.abs(rightEyeTop.y - rightEyeBottom.y);

            if (leftEyeOpenness < 0.01 || rightEyeOpenness < 0.01) return -1;

            const blinkScore = (1 / (leftEyeOpenness + rightEyeOpenness));
            const totalScore = yawScore + (blinkScore * 0.1);
            return 1 / (totalScore + 0.001);
        }

        function startRecording() {
            recordButton.disabled = true;
            recordButton.textContent = 'Recording...';
            guideText.textContent = 'Turn your head slowly';
            recordingIndicator.classList.remove('hidden');
            bestScore = -1;
            isRecording = true;

            setTimeout(() => {
                stopRecordingAndAnalyze();
            }, 5000);
        }

        function stopRecordingAndAnalyze() {
            isRecording = false;
            recordingIndicator.classList.add('hidden');
            cameraMP.stop();
            webcamContainer.classList.add('hidden');

            if (bestScore > -1) {
                showSection(processingSection);

                bestFrameCanvas.toBlob(blob => {
                    const formData = new FormData();
                    formData.append('image', blob, 'best_frame.jpg');
                    formData.append('frame_width_mm', frameWidthInput.value);
                    if (currentUserId) {
                        formData.append('user_id', currentUserId);
                    }
                    if (currentUserName) {
                        formData.append('user_name', currentUserName);
                    }
                    if (currentUserPhone) {
                        formData.append('user_phone', currentUserPhone);
                    }
                    sendFrameForAnalysis(formData);
                }, 'image/jpeg');
            } else {
                showMessage('Could not find a good quality frame. Please try again.');
                resetToCapture();
            }
        }

        async function sendFrameForAnalysis(formData) {
            try {
                const response = await fetch(`${API_BASE_URL}/process_image`, { method: 'POST', body: formData });
                if (!response.ok) {
                    const err = await response.json().catch(() => ({}));
                    throw new Error(err.error || 'Server error.');
                }
                const results = await response.json();
                displayResults(results);
            } catch (error) {
                showMessage(`Analysis Failed: ${error.message}`);
                resetToCapture();
            }
        }

        function resetToCapture() {
            showSection(captureSection);
            recordButton.textContent = 'Start 5 Second Recording';
            recordButton.disabled = true;
            startCameraButton.classList.remove('hidden');
            startCameraButton.disabled = false;
            startCameraButton.textContent = 'Start Camera';
        }

        function resetAll() {
            // Go back to instructions (after user info is already saved)
            showSection(instructionsSection);
            recordButton.textContent = 'Start 5 Second Recording';
            recordButton.disabled = true;
            startCameraButton.classList.remove('hidden');
            startCameraButton.disabled = false;
            startCameraButton.textContent = 'Start Camera';
            hideMessages();
        }

        function handleRetake() {
            // Retake with same user info - go back to instructions
            showSection(instructionsSection);
            recordButton.textContent = 'Start 5 Second Recording';
            recordButton.disabled = true;
            startCameraButton.classList.remove('hidden');
            startCameraButton.disabled = false;
            startCameraButton.textContent = 'Start Camera';
            hideMessages();
        }

        function handleExit() {
            // Exit - clear current user info and go to user info page for new user
            currentUserId = null;
            currentUserName = null;
            currentUserPhone = null;
            userName.value = '';
            userPhone.value = '';
            showSection(userInfoSection);
            hideMessages();
        }

        // ========================================
        // RESULTS DISPLAY
        // ========================================
        function displayResults(results) {
            showSection(resultsSection);

            // Display user info in the report header
            if (currentUserName) {
                reportUserName.textContent = currentUserName;
            }
            if (currentUserPhone) {
                reportUserPhone.textContent = `ðŸ“ž ${currentUserPhone}`;
            }

            const measurements = results.measurements;
            animateCounter(pdResult, measurements.pd, "mm");
            animateCounter(fhResult, measurements.fh, "mm");
            animateCounter(tiltResult, measurements.tilt, "Â°", 0);
            animateCounter(vertexResult, measurements.vertex, "mm", 0);

            if (results.landmarks && results.frameDimensions) {
                if (!renderer) init3DScene();
                render3DModel(results.landmarks, results.frameDimensions);
                d3Container.parentElement.classList.remove('hidden');
            } else {
                d3Container.parentElement.classList.add('hidden');
            }
        }

        // ========================================
        // HISTORY
        // ========================================
        async function showHistorySection() {
            showSection(historySection);
            await loadHistory();
        }

        async function loadHistory() {
            const historyLoading = document.getElementById('history-loading');
            const historyList = document.getElementById('history-list');
            const historyEmpty = document.getElementById('history-empty');

            historyLoading.classList.remove('hidden');
            historyList.classList.add('hidden');
            historyEmpty.classList.add('hidden');

            try {
                const response = await fetch(`${API_BASE_URL}/history`);
                const data = await response.json();

                historyLoading.classList.add('hidden');

                if (data.success && data.history.length > 0) {
                    renderHistoryList(data.history);
                    historyList.classList.remove('hidden');
                } else {
                    historyEmpty.classList.remove('hidden');
                }
            } catch (error) {
                historyLoading.textContent = `Error loading history: ${error.message}`;
            }
        }

        function renderHistoryList(history) {
            const historyList = document.getElementById('history-list');
            historyList.innerHTML = '';

            history.forEach((record, index) => {
                const m = record.measurements || {};
                const date = record.created_at ? formatDate(record.created_at) : 'Unknown date';

                const card = document.createElement('div');
                card.className = 'result-card rounded-lg p-4';
                card.style.animationDelay = `${index * 0.1}s`;

                card.innerHTML = `
                    <div class="flex flex-col md:flex-row md:items-center md:justify-between">
                        <div class="mb-3 md:mb-0">
                            <h3 class="font-semibold text-white text-lg">${record.user_name || 'Unknown'}</h3>
                            <p class="text-gray-400 text-sm">ðŸ“ž ${record.user_phone || 'N/A'}</p>
                            <p class="text-gray-500 text-xs mt-1">${date}</p>
                        </div>
                        <div class="grid grid-cols-4 gap-3 text-center">
                            <div>
                                <p class="text-gray-400 text-xs">PD</p>
                                <p class="text-white font-bold">${m.pd ? m.pd.toFixed(1) : '-'} mm</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs">FH</p>
                                <p class="text-white font-bold">${m.fh ? m.fh.toFixed(1) : '-'} mm</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs">Tilt</p>
                                <p class="text-white font-bold">${m.tilt ? Math.round(m.tilt) : '-'}Â°</p>
                            </div>
                            <div>
                                <p class="text-gray-400 text-xs">Vertex</p>
                                <p class="text-white font-bold">${m.vertex ? Math.round(m.vertex) : '-'} mm</p>
                            </div>
                        </div>
                    </div>
                `;
                historyList.appendChild(card);
            });
        }

        function formatDate(isoString) {
            const date = new Date(isoString);
            return date.toLocaleDateString('en-IN', {
                day: 'numeric',
                month: 'short',
                year: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }

        function animateCounter(element, finalValue, unit, decimals = 2) {
            if (!element || typeof finalValue === 'undefined') return;
            const duration = 1500;
            const startTime = performance.now();
            function update(currentTime) {
                const elapsedTime = currentTime - startTime;
                if (elapsedTime >= duration) {
                    element.textContent = `${finalValue.toFixed(decimals)} ${unit}`;
                    return;
                }
                const currentValue = (elapsedTime / duration) * finalValue;
                element.textContent = `${currentValue.toFixed(decimals)} ${unit}`;
                requestAnimationFrame(update);
            }
            requestAnimationFrame(update);
        }

        // ========================================
        // 3D SCENE
        // ========================================
        function init3DScene() {
            scene = new THREE.Scene();
            const containerBounds = d3Container.getBoundingClientRect();
            camera = new THREE.PerspectiveCamera(50, containerBounds.width / containerBounds.height, 0.1, 1000);
            camera.position.set(0, 0, 500);

            const ambientLight = new THREE.AmbientLight(0xffffff, 0.6);
            scene.add(ambientLight);
            const directionalLight = new THREE.DirectionalLight(0xffffff, 0.8);
            directionalLight.position.set(50, 50, 100);
            scene.add(directionalLight);

            const grid = new THREE.GridHelper(400, 30, 0x2563eb, 0x444444);
            grid.rotation.x = Math.PI / 2;
            grid.position.z = -150;
            scene.add(grid);

            renderer = new THREE.WebGLRenderer({ antialias: true, alpha: true });
            renderer.setSize(containerBounds.width, containerBounds.height);
            d3Container.innerHTML = '';
            d3Container.appendChild(renderer.domElement);
            controls = new THREE.OrbitControls(camera, renderer.domElement);
            controls.enableDamping = true;
            controls.autoRotate = true;
            controls.autoRotateSpeed = 1.0;
            controls.enablePan = false;
            controls.target.set(0, 0, 0);

            const animate = function () {
                requestAnimationFrame(animate);
                controls.update();
                renderer.render(scene, camera);
            };
            animate();
            window.addEventListener('resize', onWindowResize, false);
        }

        function onWindowResize() {
            if (!renderer) return;
            const containerBounds = d3Container.getBoundingClientRect();
            camera.aspect = containerBounds.width / containerBounds.height;
            camera.updateProjectionMatrix();
            renderer.setSize(containerBounds.width, containerBounds.height);
        }

        function render3DModel(landmarks, frameDimensions) {
            const oldModel = scene.getObjectByName("facePoints");
            if (oldModel) {
                scene.remove(oldModel);
                oldModel.geometry.dispose();
                oldModel.material.dispose();
            }

            const geometry = new THREE.BufferGeometry();
            const vertices = [];
            const aspectRatio = frameDimensions.width / frameDimensions.height;

            landmarks.forEach(lm => {
                const x = lm[0] - 0.5;
                const y = (lm[1] - 0.5) / aspectRatio;
                const z = lm[2];
                vertices.push(x, -y, -z);
            });

            geometry.setAttribute('position', new THREE.Float32BufferAttribute(vertices, 3));
            const material = new THREE.PointsMaterial({
                color: 0x59a6f1,
                size: 1.5,
                sizeAttenuation: true
            });

            const facePoints = new THREE.Points(geometry, material);
            facePoints.name = "facePoints";

            geometry.computeBoundingBox();
            const boundingBox = geometry.boundingBox;
            const size = new THREE.Vector3();
            boundingBox.getSize(size);
            const scale = 250 / size.length();
            facePoints.scale.set(0, 0, 0);
            scene.add(facePoints);

            let start = null;
            const duration = 750;
            const animateScale = (timestamp) => {
                if (!start) start = timestamp;
                const progress = timestamp - start;
                const easedProgress = Math.min(progress / duration, 1);
                const currentScale = scale * easedProgress;
                facePoints.scale.set(currentScale, currentScale, currentScale);
                if (progress < duration) {
                    requestAnimationFrame(animateScale);
                }
            };
            requestAnimationFrame(animateScale);

            controls.reset();
            controls.autoRotate = true;
        }

        // ========================================
        // INITIALIZATION
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            showSection(loginSection);
        });
    </script>
</body>

</html>